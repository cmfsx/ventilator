<!doctype html>
<html lang="en">

<head>
  <!-- Required meta tags -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
  <script src="https://code.highcharts.com/highcharts.js"></script>
  <script src="https://code.highcharts.com/modules/exporting.js"></script>
  <script src="https://code.highcharts.com/modules/export-data.js"></script>
  <script src="https://code.highcharts.com/modules/accessibility.js"></script>
  <script src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
  <link rel="stylesheet" type="text/css" href="css/easy_numpad.css">
  <script type="text/javascript" src="js/easy_numpad.js"></script>
  <title>LibreRespire Ventilator</title>
  <style>
    body {
      background-color: #000000;
    }

    input[type=number] {
      border: none;
      text-align: center;
      border-bottom: 2px solid blue;
      background-color: #737373;
      color: yellow;
      box-shadow: 3px 4px #262626;
    }

    #bottom_menu {
      font-color: #ffffff;
    }

    .alert {
      font-size: 16px;
    }

    .highcharts-figure,
    .highcharts-data-table table {
      min-width: 100px;
      max-width: 1000px;
      margin: 1em auto;
    }

    #pressureChart {
      width: 100%;
      height: 230px;
    }

    #flowChart {
      width: 100%;
      height: 230px;
    }

    #volumeChart {
      width: 100%;
      height: 230px;
    }

    .highcharts-background {
      background: #000000;
    }

    .highcharts-data-table table {
      font-family: Verdana, sans-serif;
      border-collapse: collapse;
      border: 1px solid #EBEBEB;
      margin: 10px auto;
      text-align: center;
      width: 100%;
      max-width: 500px;
    }

    .highcharts-data-table caption {
      padding: 1em 0;
      font-size: 1.2em;
      color: #555;
    }

    .highcharts-data-table th {
      font-weight: 600;
      padding: 0.5em;
    }

    .highcharts-data-table td,
    .highcharts-data-table th,
    .highcharts-data-table caption {
      padding: 0.5em;
    }

    .highcharts-data-table thead tr,
    .highcharts-data-table tr:nth-child(even) {
      background: #f8f8f8;
    }

    .highcharts-data-table tr:hover {
      background: #f1f7ff;
    }
  </style>
  <script type="text/javascript">
    jQuery(document).ready(function() {
      $("#fio2_input").bind("change paste keyup", function() {
        $("#fio2").html($(this).val())
        $.get("/api/configs/fio2?fio2=" + $(this).val(), function(data, status) {})
      });
      $("#rr_input").bind("change paste keyup", function() {
        $("#rr").html("1 : " + $(this).val())
        $.get("/api/configs/rr?rr=" + $(this).val(), function(data, status) {})
      });
      $("#ie_ratio_input").bind("change paste keyup", function() {
        $("#ie_ratio").html("1 : " + $(this).val())
        $.get("/api/configs/ie?ie=" + $(this).val(), function(data, status) {})
      });
      $("#peep_input").bind("change paste keyup", function() {
        $("#peep").html($(this).val())
        $.get("/api/configs/peep?peep=" + $(this).val(), function(data, status) {})
      });
      $("#tidle_volume_input").bind("change paste keyup", function() {
        $("#tidle_volume").html($(this).val())
        $.get("/api/configs/vt?vt=" + $(this).val(), function(data, status) {})
      });
      $("#pmax_input").bind("change paste keyup", function() {
        $("#pmax").html($(this).val())
        $.get("/api/configs/pmax?pmax=" + $(this).val(), function(data, status) {})
      });
      $("#pip_input").bind("change paste keyup", function() {
        $("#pip").html($(this).val())
        $.get("/api/configs/pip?pip=" + $(this).val(), function(data, status) {})
      });

      mode_selector(1);
      $("#logo").show();
      $("#alert").hide();
    });

    function calib_flow() {
      $.get("/api/configs/calib_flow_rate?calib_flow_rate=" + $("#calibarate_flow_input").val(), function(data, status) {});
      $('#calibarate').modal('hide')
    }

    function mode_selector(mode) {
      $.get("/api/configs/mode?mode=" + mode, function(data, status) {});
      if (mode == 1) {
        $("#tidle_volume_input").prop("disabled", true).css("background-color", "#3c3d3d");
        $("#pmax_input").prop("disabled", false).css("background-color", "#737373");
        $("#pip_input").prop("disabled", false).css("background-color", "#737373");
      } else if (mode == 2) {
        $("#pmax_input").prop("disabled", true).css("background-color", "#3c3d3d");
        $("#pip_input").prop("disabled", true).css("background-color", "#3c3d3d");
        $("#tidle_volume_input").prop("disabled", false).css("background-color", "#737373");
      }
    }
  </script>
</head>

<body>
  <dev>
    <div class="container-fluid">
      <div class="modal fade" id="calibarate" tabindex="-1" role="dialog" aria-labelledby="calibarateModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="calibarateModalLabel">Flow control calibration</h5>
              <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body">
              <p>Please enter flow rate in L/min.</p>
              <input type="tel" class="keyboard form-control" id="calibarate_flow_input" type="number" onclick="show_easy_numpad(this);">
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
              <button type="button" class="btn btn-primary" id="calibarate_flow" onclick="calib_flow(this);">Save changes</button>
            </div>
          </div>
        </div>
      </div>
      <div class="row align-items-center" width="100%">
        <div class="col">
          <div class="dropdown">
            <button class="btn btn-lg btn-secondary dropdown-toggle" style="width: 100%" type="button" id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">
              Ventilator Mode
            </button>
            <div class="dropdown-menu" aria-labelledby="dropdownMenuButton">
              <a class="dropdown-item" href="#" style="font-size:30px;font-style:initial;" onclick="mode_selector(1);">Pressure Control</a>
              <a class="dropdown-item" href="#" style="font-size:30px;font-style:initial;" onclick="mode_selector(2);">Volume Control</a>
            </div>
          </div>
        </div>
        <div class="col-xl">
          <div class="card text-center" id="logo">
            <img src="/images/librerespire.svg" width="100%" height="100px" alt="">
          </div>
          <div class="alert" id="alert" role="alert">
          </div>
        </div>
        <div class="col">
          <div class="dropdown">
            <button class="btn btn-lg btn-secondary dropdown-toggle" style="width: 100%" type="button" id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">
              Settings
            </button>
            <div class="dropdown-menu" aria-labelledby="dropdownMenuButton">
              <a class="dropdown-item" href="#" data-toggle="modal" style="font-size:30px;font-style:initial;" data-target="#calibarate">Calibarate</a>
              <a class="dropdown-item" href="#" id="restart" style="font-size:30px;font-style:initial;">Restart</a>
              <a class="dropdown-item" href="#" id="shutdown" style="font-size:30px;font-style:initial;">Shutdown</a>
            </div>
          </div>
        </div>
      </div>
      <div class="row align-items-center" width="100%">
        <div class="col-xl">
          <figure class="highcharts-figure">
            <div id="pressureChart"></div>
          </figure>
          <figure class="highcharts-figure">
            <div id="flowChart"></div>
          </figure>
          <figure class="highcharts-figure">
            <div id="volumeChart"></div>
          </figure>
        </div>
        <div class="col-xl">
          <table class="table table-borderless table-dark">
            <tbody>
              <tr>
                <td style="width: 50%">
                  <div class="card bg-dark text-center">
                    <div class="card-body">
                      <div>Tidal Volume</div>
                      <div id="tidle_volume" style="font-size:40px;font-style:initial;">500</div>
                      <input class="keyboard form-control" id="tidle_volume_input" type="number" onclick="show_easy_numpad(this);">
                    </div>
                  </div>
                </td>
                <td style="width: 50%">
                  <div class="card bg-dark text-center">
                    <div class="card-body">
                      <div>Minute Volume</div>
                      <div id="min_volume" style="font-size:40px;font-style:initial;">5000</div>
                      <br>
                    </div>
                  </div>
                </td>
              </tr>
              <tr>
                <td>
                  <div class="card bg-dark text-center">
                    <div class="card-body">
                      <div>PIP</div>
                      <div id="pip" style="font-size:40px;font-style:initial;">15</div>
                      <input class="keyboard form-control" id="pip_input" type="number" onclick="show_easy_numpad(this);">
                    </div>
                  </div>
                </td>
                <td>
                  <div class="card bg-dark text-center">
                    <div class="card-body">
                      <div>PEEP</div>
                      <div id="peep" style="font-size:40px;font-style:initial;">5</div>
                      <input class="keyboard form-control" id="peep_input" type="number" onclick="show_easy_numpad(this);">
                    </div>
                  </div>
                </td>
              </tr>
              <tr>
                <td>
                  <div class="card bg-dark text-center">
                    <div class="card-body">
                      <div>FiO<sub>2</sub></div>
                      <div id="fio2" style="font-size:40px;font-style:initial;">40</div>
                      <input class="keyboard form-control" id="fio2_input" type="number" onclick="show_easy_numpad(this);">
                    </div>
                  </div>
                </td>
                <td>
                  <div class="card bg-dark text-center">
                    <div class="card-body">
                      <div>R.R.</div>
                      <div id="rr" style="font-size:40px;font-style:initial;">10</div>
                      <input class="keyboard form-control" id="rr_input" type="number" onclick="show_easy_numpad(this);">
                    </div>
                  </div>
                </td>
              </tr>
              <tr>
                <td>
                  <div class="card bg-dark text-center">
                    <div class="card-body">
                      <div>Pmax</div>
                      <div id="pmax" style="font-size:40px;font-style:initial;">60</div>
                      <input class="keyboard form-control" id="pmax_input" type="number" onclick="show_easy_numpad(this);">
                    </div>
                  </div>
                </td>
                <td>
                  <div class="card bg-dark text-center">
                    <div class="card-body">
                      <div>IE Ratio</div>
                      <div id="ie_ratio" style="font-size:40px;font-style:initial;">1 : 2</div>
                      <input class="keyboard form-control" id="ie_ratio_input" type="number" onclick="show_easy_numpad(this);">
                    </div>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Chart JavaScript -->
    <script type="text/javascript">
      $(function() {
        // Pressure chart
        var PressureData = [];
        var pressureChart = Highcharts.chart({
          chart: {
            renderTo: 'pressureChart',
            type: 'area',
            backgroundColor: '#000000'
          },
          credits: {
            enabled: false
          },
          exporting: {
            enabled: false
          },
          title: {
            text: null,
            enable: false
          },
          xAxis: {
            type: 'datetime',
            tickPixelInterval: 150,
            dateTimeLabelFormats: {
              millisecond: '%S.%L',
              second: '%S'
            },
          },
          time: {
            useUTC: false
          },
          yAxis: {
            title: {
              text: 'Pressure'
            },
            type: 'linear',
            minorTickInterval: 'auto'
          },
          legend: {
            enabled: false
          },
          series: [{
            name: 'Pressure',
            marker: {
              enabled: false
            },
            color: '#0066FF',
            data: PressureData
          }],
        });
        setInterval(function() {
          $.get("/api/graphs/pressure", function(data, status) {
            PressureData = data['data'];
          });
          pressureChart.series[0].setData(PressureData);
        }, 1000);
      });

      $(function() {
        // Flow chart
        var flowData = [];

        var flowChart = Highcharts.chart({
          chart: {
            renderTo: 'flowChart',
            type: 'area',
            backgroundColor: '#000000'
          },
          credits: {
            enabled: false
          },
          exporting: {
            enabled: false
          },
          time: {
            useUTC: false
          },
          title: {
            text: null,
            enable: false
          },
          xAxis: {
            type: 'datetime',
            dateTimeLabelFormats: {
              second: '%S'
            },
          },
          yAxis: {
            title: {
              text: 'Flow'
            },
            type: 'linear',
            minorTickInterval: 'auto'
          },
          legend: {
            enabled: false
          },
          series: [{
            name: 'Flow',
            marker: {
              enabled: false
            },
            color: '#ebeb34',
            data: flowData
          }],
        });
        setInterval(function() {
          $.get("/api/graphs/flowrate", function(data, status) {
            flowData = data['data'];
          });
          flowChart.series[0].setData(flowData);
        }, 1000);
      });

      $(function() {
        var volumeData = [];
        // Volume chart
        var volumeChart = Highcharts.chart({
          chart: {
            renderTo: 'volumeChart',
            type: 'area',
            backgroundColor: '#000000'
          },
          credits: {
            enabled: false
          },
          exporting: {
            enabled: false
          },
          title: {
            text: null,
            enable: false
          },
          xAxis: {
            type: 'datetime',
            tickPixelInterval: 150,
            dateTimeLabelFormats: {
              millisecond: '%S.%L',
              second: '%S'
            },
          },
          yAxis: {
            title: {
              text: 'Volume'
            },
            type: 'linear',
            minorTickInterval: 'auto'
          },
          time: {
            useUTC: false
          },
          legend: {
            enabled: false
          },
          series: [{
            name: 'Volume',
            marker: {
              enabled: false
            },
            color: '#c5d4d3',
            data: volumeData
          }],
        });
        setInterval(function() {
          $.get("/api/graphs/volume", function(data, status) {
            volumeData = data['data'];
          });
          volumeChart.series[0].setData(volumeData);
        }, 1000);
      });

      setInterval(function() {
        $.get("/api/table/values", function(data, status) {
          $("#tidle_volume").html(data['vt']);
          $("#min_volume").html(data['minute_volume']);
          $("#pip").html(data['pip']);
        });
      }, 1000);

      setInterval(function() {
        var major_alerts = false;
        var minor_alerts = false;
        messages = {};
        $("#alert").html();
        $.get("/api/alarms/major", function(data, status) {
          if (data) {
            var div = "";
            major_alerts = true;
            var messages = Object.keys(data).map(function(key) {
              return data[key];
            });
            console.log("major: " + messages);
            div = "<div class='alert alert-danger alert-dismissible fade show' role='alert'> " + messages.toString() +
              '<button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span>' +
              "</button></div>";
            $("#alert").html(div);
            // $("#logo").hide();
            // $("#alert").show();
          }
        });
        $.get("/api/alarms/minor", function(data, status) {
          if (data) {
            var div = "";
            minor_alerts = true;
            var messages = Object.keys(data).map(function(key) {
              return data[key];
            });
            console.log("minor: " + messages);
            div = "<div class='alert alert-warning alert-dismissible fade show' role='alert'> " + messages.toString() +
              '<button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span>' +
              "</button></div>";
            $("#alert").html(div);
            $("#logo").hide();
            $("#alert").show();
          }
        });
      }, 1000);
    </script>
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js" integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous"></script>
</body>

</html>
